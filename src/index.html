<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/pts/dist/pts.min.js"></script>
    <!-- D3 Color -->
    <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-time@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-time-format@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic"></script>
  </head>
  <body>
    <div id="pt" style="width: 600px; height: 600px; margin: 30px auto 0"></div>
  </body>

  <script>
    const numToString = (num, length) => String(num).padStart(length, "0");

    const kaprekarInitial = (limit, convertToString) => {
      const ret = [];

      //  at least two unique digits
      const valid = (numString) =>
        [...numString].filter((v, i, a) => a.indexOf(v) === i).length >= 2;

      let i = 0;
      while (ret.length < limit) {
        const numString = convertToString(i);

        if (valid(numString)) ret.push(numString);
        i++;
      }

      return ret;
    };

    const constructKaprekarSeries = (initial, convertToString, length = 10) => {
      const ret = [initial];

      let count = 0;
      while (ret.length != length) {
        //   trim down to something useful
        const prev = ret[ret.length - 1];
        const asc = [...prev].sort().join("");
        const desc = [...asc].reverse().join("");

        const newNum = convertToString(Number(desc) - Number(asc));

        if (newNum == prev || count >= length) break;

        count++;

        ret.push(newNum);
      }

      return count;
    };

    const conversion = (n) => numToString(n, 4);

    window.demoDescription = "Kaprekar Study";

    Pts.quickStart("#pt", "#123");

    //// Demo code starts (anonymous function wrapper is optional) ---

    const [rows, cols] = [100, 100];

    const [wrappingRows, wrappingCols] = [25, 25];

    const limit = 40;
    const series = kaprekarInitial(wrappingRows * wrappingCols, conversion).map(
      (init) => constructKaprekarSeries(init, conversion, limit)
    );

    const maxConversion = Math.max(...series.filter((v) => v != limit - 1));

    var pts = [];

    space.add({
      start: (bound) => {
        pts = Create.gridCells(space.innerBound, rows, cols);
      },

      animate: () => {
        // calculate the size and color of each cell based on its distance to the pointer
        pts.map((p, index) => {
          const r = Rectangle.fromCenter(
            Rectangle.center(p),
            Rectangle.size(p)
          );

          // mirror the internal tiles
          const row = Math.abs(
            (Math.floor(index / rows) % (2 * wrappingRows)) - wrappingRows
          );
          const col = Math.abs(
            ((index % cols) % (2 * wrappingCols)) - wrappingCols
          );

          const newIndex = row * wrappingRows + col;
          // console.log(newIndex);

          const elem = series[newIndex];

          const color = d3
            .scaleSequential(d3.interpolateSinebow)
            .domain([0, maxConversion])(elem);
          form.stroke(color).fill(color).rect(r);
        });
      },
    });

    //// ----

    space.playOnce();
  </script>
</html>
